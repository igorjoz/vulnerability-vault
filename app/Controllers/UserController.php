<?php

require_once '../views/LayoutView.php';
require_once '../views/RedirectView.php';

class UserController {
    public function login() {
        
        $userModel = new User();
        $userModel->createDatabase();
        if ($_SERVER['REQUEST_METHOD'] === 'POST') {
            if (isset($_POST['unsafe'])) {
                $username = $_POST['username'];
                $password = $_POST['password'];

                $user = $userModel->getUnsafe($username, $password);
                if ($user) {
                    $_SESSION['username'] = $user['username'];
                    $_SESSION['id'] = $user['id'];
                    echo "Zalogowano jako $username";
                    return new RedirectView('/vulnerability-vault/sql-injection', 303);                
                } else {
                    unset($_SESSION['username']);
                    echo "Niepoprawne dane logowania";
                    return new RedirectView('/vulnerability-vault/sql-injection', 404);                
                }
                
            } elseif (isset($_POST['safe'])) {
                $username = $_POST['username'];
                $password = $_POST['password'];

                $user = $userModel->getSafe($username, $password);

                if ($user) {
                    $_SESSION['username'] = $user['username'];
                    $_SESSION['id'] = $user['id'];
                    echo "Zalogowano jako $username";
                    return new RedirectView('/vulnerability-vault/sql-injection', 303);                
                } else {
                    echo "Niepoprawne dane logowania";
                    unset($_SESSION['username']);
                    return new RedirectView('/vulnerability-vault/sql-injection', 404);                
                }          

            }
        }
    }

    public function register() {
        echo "register";
        $userModel = new User();
        $userModel->createDatabase();
        if ($_SERVER['REQUEST_METHOD'] === 'POST') {
            if (isset($_POST['unsafe'])) {
                $username = $_POST['username'];
                $password = $_POST['password'];
                $affectedRows = $userModel->registerSafe($username, $password);

                if ($affectedRows > 0) {
                    echo "Zalogowano jako $username";
                } else {
                    echo "Blad";
                }

                return new RedirectView('/vulnerability-vault/sql-injection', 303);                

            } elseif (isset($_POST['safe'])) {
                $username = $_POST['username'];
                $password = $_POST['password'];

                $affectedRows = $userModel->registerSafe($username, $password);

                if ($affectedRows > 0) {
                    echo "Zalogowano jako $username";
                } else {
                    echo "Blad";
                }
                return new RedirectView('/vulnerability-vault/sql-injection', 303);                

            }
        }
    }
}
?>