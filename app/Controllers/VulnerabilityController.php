<?php

require_once '../app/Services/PathService.php';

class VulnerabilityController
{
    public $directoryPath = VIEWS_PATH_PREFIX . 'vulnerabilities/';

    public function xssReflected(): int
    {
        return require_once($this->directoryPath . 'xss-reflected/xss-reflected.php');
    }

    public function xssStored(): int
    {
        return require_once($this->directoryPath . 'xss-stored/xss-stored.php');
    }

    public function sqlInjection(): int
    {
        return require_once($this->directoryPath . 'sql-injection/sql-injection.php');
    }

    public function commandInjection(): int
    {
        return require_once($this->directoryPath . 'command-injection/command-injection.php');
    }

    public function fileUploader(): int
    {
       
        return require_once($this->directoryPath . 'file-uploader/file-uploader.php');
    }

    public function upload()
    {
        $target_dir = "uploads/";
        $target_file = $target_dir . basename($_FILES["fileToUpload"]["name"]);
       
        if ($_SERVER['REQUEST_METHOD'] === 'POST') {
            if(isset($_POST["unsafe_submit"])) {
                
                if (move_uploaded_file($_FILES["fileToUpload"]["tmp_name"], $target_file)) {
                    echo "The file ". htmlspecialchars( basename( $_FILES["fileToUpload"]["name"])). " has been uploaded.";
                  } else {
                    echo "Sorry, there was an error uploading your file.";
                  }
            }

            elseif (isset($_POST['safe_submit'])) {
                $correct = 0;
                @$check_error = getimagesize($_FILES["fileToUpload"]["tmp_name"]);

                // Checking if an actual image
                if( $check_error!== false) {
                    // Image
                    $correct = 1;
                } else {
                    // Not an image
                    $correct = 0;
                }

                // Check if already exists
                if (file_exists($target_file)) {
                    // Checking if file already exists
                    $correct = 0;
                }

                // Check the size
                if ($_FILES["fileToUpload"]["size"] > 100000 or $_FILES["fileToUpload"]["size"] == 0 ) {
                    //Too large
                    $correct = 0;
                  }

                // Check the extension
                $imageFileType = strtolower(pathinfo($target_file,PATHINFO_EXTENSION));
                $uploaded_type = $_FILES[ 'fileToUpload' ][ 'type' ];
                $uploaded_name = $_FILES[ 'fileToUpload' ][ 'name' ];
                $uploaded_ext  = substr( $uploaded_name, strrpos( $uploaded_name, '.' ) + 1);

                if($imageFileType != "jpg" && $imageFileType != "png" && $imageFileType != "jpeg"
                  && $imageFileType != "gif" && ( $uploaded_type == 'image/jpeg' || $uploaded_type == 'image/png' )) {
                      //Wrong extension
                      $uploadOk = 0;
                }
                /*
                $uploaded_tmp  = $_FILES[ 'fileToUpload' ][ 'tmp_name' ];
                $temp_file     = ( ( ini_get( 'upload_tmp_dir' ) == '' ) ? ( sys_get_temp_dir() ) : ( ini_get( 'upload_tmp_dir' ) ) );
	            $temp_file    .= DIRECTORY_SEPARATOR . md5( uniqid() . $uploaded_name ) . '.' . $uploaded_ext;


                // Strip any metadata, by re-encoding image
		        if( $uploaded_type == 'image/jpeg' ) {
			        $img = imagecreatefromjpeg( $uploaded_tmp );
			        imagejpeg( $img, $temp_file, 100);
		        }
		        else {
			        $img = imagecreatefrompng( $uploaded_tmp );
			        imagepng( $img, $temp_file, 9);
		        }
		        imagedestroy( $img );   

                */
                if ($correct == 0){
                    echo "Sorry, your file was not uploaded.";
                }
                else{
                    if (move_uploaded_file($_FILES["fileToUpload"]["tmp_name"], $target_file)) {
                        echo "The file ". htmlspecialchars( basename( $_FILES["fileToUpload"]["name"])). " has been uploaded.";
                       } else {
                         echo "Sorry, there was an error uploading your file.";
                      }
                }

                // Delete any temp files
               /*
                if( file_exists( $temp_file ) ){
                    unlink( $temp_file );
                }
*/

            }
        }
        
        return require_once($this->directoryPath . 'file-uploader/file-uploader.php');
    }
}
